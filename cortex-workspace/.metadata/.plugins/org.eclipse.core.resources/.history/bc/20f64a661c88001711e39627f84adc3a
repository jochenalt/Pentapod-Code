/*
 * BinaryCommandInterface.h
 *
 *  Created on: 14.08.2017
 *      Author: JochenAlt
 */

#ifndef I2CSLAVE_H_
#define I2CSLAVE_H_

#include "i2c_t3-v9.1.h"
#include "CortexComPackage.h"
class I2CSlave {
public:
	I2CSlave();
	virtual ~I2CSlave();

	static I2CSlave& getInstance();

	void setup(i2c_t3* wire);
	void loop();


	void executeRequest();

	void onBlockReceive(size_t howManyBytes);
	void onRequest();

private:
	// our i2c line to cortex
	i2c_t3* wire = NULL;

	// buffer that is able to sum up multiple requests to one big data array
	// (i2c has a maximum size of 32 bytes per request)
	static const unsigned int maxBufferSize = 512;
	uint8_t receiveBuffer[maxBufferSize];
	unsigned int receiveBufferLen;

	// semaphor set in onRequest indicating that a request as been received and is ready to be executed in the main loop
	// (within a interrupt, no big tasks should be executed)
	bool requestPending;
	Cortex::RequestPackageData request;

	// semanphor set in onReceive, indicating that a response has been created that can be sent to the master
	bool responsePending;
	Cortex::ResponsePackageData response;

};

extern I2CSlave i2cSlave;

#endif /* I2CSLAVE_H_ */
